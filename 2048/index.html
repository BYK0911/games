<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2048</title>
  <style>
    .wrap {
      position: absolute;
      left: 50%;
      transform: translate(-50%, 0)
    }
    .panel {
      display: flex;
      justify-content: space-between;
      align-content: space-between;
      flex-wrap: wrap;
      width: 210px;
      height: 210px;
      border-radius: 10px;
      border: 2px solid #ddd;
      padding: 5px;
    }
    .grid {
      flex: none;
      width: 50px;
      height: 50px;
      border-radius: 6px;
      overflow: hidden;
    }
    .grid::after {
      display: block;
      width: 100%;
      height: 100%;
      line-height: 50px;
      text-align: center;
      font-size: 20px;
      color: #fff;
    }
    .grid-0::after {
      content: '';
      background-color: #f0f0f0;
    }
    .grid-2::after {
      content: '2';
      background-color: #fec;
    }
    .grid-4::after {
      content: '4';
      background-color: #fcc;
    }
    .grid-8::after {
      content: '8';
      background-color: #fba;
    }
    .grid-16::after {
      content: '16';
      background-color: #fa9;
    }
    .grid-32::after {
      content: '32';
      background-color: #f98;
    }
    .grid-64::after {
      content: '64';
      background-color: #f87;
    }
    .grid-128::after {
      content: '128';
      background-color: #f76;
    }
    .grid-256::after {
      content: '256';
      background-color: #f65;
    }
    .grid-512::after {
      content: '512';
      background-color: #f57;
    }
    .grid-1024::after {
      content: '1024';
      background-color: #f4f;
    }
    .grid-2048::after {
      content: '2048';
      background-color: #b5f;
    }
    .grid-4096::after {
      content: '4096';
      background-color: #65f;
    }
    .controls {
      position: fixed;
      bottom: 10px;
      right: 14px;
      text-align: center;
    }
    .row { margin-bottom: 4px;}
    .btn {
      display: inline-block;
      vertical-align: middle;
      width: 60px;
      height: 32px;
      line-height: 32px;
      border-radius: 3px;
      border: 1px solid #ddd;
      background-color: #f0f0f0;
      color: #333;
      font-size: 14px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="wrap"></div>
  <div class="controls">
    <div class="row">
      <div class="btn" onclick="move(38)">UP</div>
    </div>
    <div class="row">
      <div class="btn" onclick="move(37)">LEFT</div>
      <div class="btn"></div>
      <div class="btn" onclick="move(39)">RIGHT</div>
    </div>
    <div class="row">
      <div class="btn" onclick="move(40)">DOWN</div>
    </div>
  </div>
  <script>
    G2048 = {
      data: [],
      grids: {},

      init (dom) {
        const panel = document.createElement('div')
        panel.className = 'panel'
        for (let i = 0; i < 4; i++) {
          for (let j = 0; j < 4; j++) {
            const g = document.createElement('div')
            g.className = 'grid'
            this.grids['g' + i + j] = g
            panel.appendChild(g)
          }
        }
        dom.appendChild(panel)
      },

      start () {
        this.data = []
        for (let i = 0; i < 4; i++) {
          this.data.push(new Array(4).fill(0))
        }
        this.random()
        this.random()
        this.render()
      },
      random () {
        const list = []
        for (let i = 0; i < 4; i++) {
          for (let j = 0; j < 4; j++) {
            if (this.data[i][j] === 0) {
              list.push([i, j])
            }
          }
        }
        if (list.length) {
          let i = Math.floor(Math.random() * list.length)
          const [r, c] = list[i]
          const n = Math.random() > .5 ? 4 : 2
          this.data[r][c] = n
        }
      },
      render () {
        for (let i = 0; i < 4; i++) {
          for (let j = 0; j < 4; j++) {
            this.grids['g' + i + j].className = 'grid grid-' + this.data[i][j]
          }
        }
      },
      up () {
        for (let c = 0; c < 4; c++) {
          let a = 0; sums = []
          for (let r = 0; r < 4; r++) {
            const n = this.data[r][c]
            if (n === 0) continue
            if (a === 0) a = n
            else if (n === a) {
              sums.push(n * 2)
              a = 0
            } else {
              sums.push(a)
              a = n
            }
          }
          sums.push(a)
          for (let r = 0; r < 4; r++) {
            this.data[r][c] = sums[r] || 0
          }
        }
      },
      down () {
        for (let c = 0; c < 4; c++) {
          let a = 0; sums = []
          for (let r = 3; r >= 0; r--) {
            const n = this.data[r][c]
            if (n === 0) continue
            if (a === 0) {
              a = n
            } else if (n === a) {
              sums.push(n * 2)
              a = 0
            } else {
              sums.push(a)
              a = n
            }
          }
          sums.push(a)
          for (let r = 0; r < 4; r++) {
            this.data[r][c] = sums[3 - r] || 0
          }
        }
      },
      left () {
        for (let r = 0; r < 4; r++) {
          let a = 0; sums = []
          for (let c = 0; c < 4; c++) {
            const n = this.data[r][c]
            if (n === 0) continue
            if (a === 0) a = n
            else if (n === a) {
              sums.push(n * 2)
              a = 0
            } else {
              sums.push(a)
              a = n
            }
          }
          sums.push(a)
          for (let c = 0; c < 4; c++) {
            this.data[r][c] = sums[c] || 0
          }
        }
      },
      right () {
        for (let r = 0; r < 4; r++) {
          let a = 0; sums = []
          for (let c = 3; c >= 0; c--) {
            const n = this.data[r][c]
            if (n === 0) continue
            if (a === 0) a = n
            else if (n === a) {
              sums.push(n * 2)
              a = 0
            }else {
              sums.push(a)
              a = n
            }
          }
          sums.push(a)
          for (let c = 0; c < 4; c++) {
            this.data[r][c] = sums[3 - c] || 0
          }
        }
      },
      move (dir) {
        if (dir === 1) {
          if(!this.canUp()) return
          this.up()
        } else if (dir === 2) {
          if(!this.canRight()) return
          this.right()
        } else if (dir === 3) {
          if(!this.canDown()) return
          this.down()
        } else if (dir === 4) {
          if(!this.canLeft()) return
          this.left()
        }
        
        this.random()
        this.render()
        
        if (this.die()) {
          this.gameover()
        }
      },

      die () {
        return !(this.canLeft() || this.canRight() || this.canUp() || this.canDown())
      },

      canLeft () {
        for (let r = 0; r < 4; r++) {
          let a = 0
          for (let c = 3; c >= 0; c--) {
            let n = this.data[r][c]
            if (a === 0) {
              a = n
            } else if (n === 0 || a === n) {
              return true
            } else {
              a = n
            }
          }
        }
      },

      canRight () {
        for (let r = 0; r < 4; r++) {
          let a = 0
          for (let c = 0; c < 4; c++) {
            let n = this.data[r][c]
            if (a === 0) {
              a = n
            } else if (n === 0 || a === n) {
              return true
            } else {
              a = n
            }
          }
        }
      },

      canUp () {
        for (let c = 0; c < 4; c++) {
          let a = 0
          for (let r = 3; r >= 0; r--) {
            let n = this.data[r][c]
            if (a === 0) {
              a = n
            } else if (n === 0 || a === n) {
              return true
            } else {
              a = n
            }
          }
        }
      },
      
      canDown () {
        for (let c = 0; c < 4; c++) {
          let a = 0
          for (let r = 0; r < 4; r++) {
            let n = this.data[r][c]
            if (a === 0) {
              a = n
            } else if (n === 0 || a === n) {
              return true
            } else {
              a = n
            }
          }
        }
      },

      gameover () {
        setTimeout(() => alert('Game over'))
      }
    }
  </script>
  <script>
    G2048.init(document.querySelector('.wrap'))
    G2048.start()

    function move (code) {
      switch(code) {
        case 37:
          G2048.move(4)
          break
        case 38:
          G2048.move(1)
          break
        case 39:
          G2048.move(2)
          break
        case 40:
          G2048.move(3)
          break
        case 32:
          G2048.start()
          break
      }
    }

    window.onkeydown = e => move(e.keyCode)
  </script>
</body>
</html>