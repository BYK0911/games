<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    body {
      text-align: center;
    }
    canvas {
      vertical-align: middle;
    }
    .wrap {
      display: inline-block;
    }
    .controls {
      display:flex;
      justify-content: space-between;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="teris" onclick="start()"></div>
    <div class="controls">
      <button onclick="move(-1, 0)"> ⮜ </button>
      <button onclick="moveDown()"> ⮟ </button>
      <button onclick="trans()"> TRANS </button>
      <button onclick="move(1, 0)"> ⮞ </button>
    </div>
  </div>

  <script>
    const Teris = {
      panel: [],
      elems: [
        { x: 4, y: -1, width: 4, height: 1, data: [[1, 1, 1, 1]] },
        { x: 5, y: -2, width: 2, height: 2, data: [[1, 1], [1, 1]] },
        { x: 5, y: -4, width: 1, height: 4, data: [[1], [1], [1], [1]] },
        { x: 5, y: -3, width: 2, height: 3, data: [[1, 0], [1, 1], [0, 1]] },
        { x: 5, y: -2, width: 3, height: 2, data: [[1, 1, 0], [0, 1, 1]] },
        { x: 5, y: -2, width: 3, height: 2, data: [[0, 1, 1], [1, 1, 0]] },
        { x: 5, y: -2, width: 3, height: 2, data: [[0, 1, 0], [1, 1, 1]] },
        { x: 5, y: -2, width: 3, height: 2, data: [[1, 0, 0], [1, 1, 1]] },
        { x: 5, y: -2, width: 3, height: 2, data: [[0, 0, 1], [1, 1, 1]] },
      ],
      currElem: null,
      nextElem: null,
      animationId: null,
      timer: null,
      rows: 20,
      cols: 12,
      gridSize: 20,
      scores: 0,
      status: 0,

      init (dom) {
        const cvs = document.createElement('canvas')
        const ctx = cvs.getContext('2d')
        const w = this.cols * this.gridSize + 20
        const h = this.rows * this.gridSize + 50
        cvs.width = w
        cvs.height = h
        cvs.style.width = w + 'px'
        cvs.style.height = h + 'px'
        
        dom.innerHTML = ''
        dom.appendChild(cvs)
        this.ctx = ctx

        this.initPanel();
        this.render()
        this.initEvent()
      },

      initEvent () {
        window.addEventListener('keydown', e => {
          const keyCode = e.keyCode
          if (!this.status) return this.start()

          if (keyCode === 37 || keyCode === 39) {
            const dx = keyCode === 37 ? -1 : 1
            if (this.canMove(dx, 0)) {
              this.move(dx, 0)
            }
          } else if (keyCode === 40) {
            while(this.canMove(0, 1)) {
              this.move(0, 1)
            }
          } else if (keyCode === 38) {
            this.transform()
          }
        })
      },

      start () {
        this.status = 1;
        this.scores = 0;
        this.genNext();
        this.currElem = this.nextElem;
        this.genNext();

        const render = () => {
          if (this.status === 1) {
            this.render()
            this.animationId = window.requestAnimationFrame(render)
          }
        }
        const autoMoveDown = () => {
          if (this.status === 1) {
            this.autoMove()
            this.timer = setTimeout(autoMoveDown, 500)
          }
        }

        autoMoveDown()
        render()
      },

      initPanel () {
        for (let r = 0; r < this.rows; r++) {
          this.panel.push(new Array(this.cols).fill(0))
        }
      },

      gameover () {
        this.status = 2
        window.cancelAnimationFrame(this.animationId)
        clearTimeout(this.timer)
        this.animationId = null
        this.timer = null

        alert('Game over! Scores ' + this.scores)
      },

      render () {
        const ctx = this.ctx
        const gridSize = this.gridSize

        ctx.clearRect(0, 0, 500, 500)
        ctx.strokeStyle = '#ddd'
        ctx.fillStyle = '#000'
        ctx.font = '14px Arial'

        const score = '得分：' + this.scores
        ctx.fillText(score, 10, 30)

        if (this.nextElem) {
          const { width, height, data } = this.nextElem
          const x = this.cols * gridSize - 10
          const y = 20
          for (let i = 0; i < height; i++) {
            for (let j = 0; j < width; j++) {
              if (data[i][j]) {
                ctx.beginPath()
                ctx.rect(x + j * 5, y + i * 5, 5, 5)
                ctx.closePath()
                ctx.fill()
                ctx.stroke()
              }
            }
          }
        }

        ctx.save()
        ctx.translate(10, 40)

        for (let r = 0; r < this.rows; r++) {
          for (let c = 0; c < this.cols; c++) {
            ctx.fillStyle = this.panel[r][c] ? '#000' : '#f0f0f0'
            ctx.beginPath()
            ctx.rect(c * gridSize, r * gridSize, gridSize, gridSize)
            ctx.closePath()
            ctx.fill()
            ctx.stroke()
          }
        }

        if (this.currElem) {
          const { x: c, y: r, width, height, data } = this.currElem
          for (let i = 0; i < height; i++) {
            for (let j = 0; j < width; j++) {
              const _r = r + i
              const _c = c + j
              if (_r >= 0 && data[i][j]) {
                ctx.fillStyle = '#000'
                ctx.beginPath()
                ctx.rect(_c * gridSize, _r * gridSize, gridSize, gridSize)
                ctx.closePath()
                ctx.fill()
                ctx.stroke()
              }
            }
          }
        }
        ctx.restore()
      },

      autoMove () {
        const canMove = this.canMove(0, 1)
        if (canMove) {
          this.move(0, 1)
        } else if (this.currElem.y <= 0) {
          this.gameover()
        } else {
          this.updatePanel()
          this.checkScore()
          this.currElem = this.nextElem
          this.genNext()
        }
      },

      move (dx, dy) {
        this.currElem.x += dx
        this.currElem.y += dy
      },

      transform () {
        const { x, y, width, height, data } = this.currElem
        let _data = []
        for (let i = 0; i < width; i++) {
          let row = []
          for (let j = 0; j < height; j++) {
            row[j] = data[j][width - 1 - i]
          }
          _data.push(row)
        }
        this.currElem.width = height
        this.currElem.height = width
        this.currElem.y = y + height - 1
        this.currElem.data =  _data

        if (!this.canMove(0, 0)) {
          this.currElem.width = width
          this.currElem.height = height
          this.currElem.data =  data
        }
      },

      genNext () {
        const i = Math.floor(Math.random() * this.elems.length)
        this.nextElem = { ...this.elems[i] }
      },

      canMove (dx, dy) {
        let { x, y, width, height, data } = this.currElem
        x += dx
        y += dy
        
        if (y + height > this.rows) return false
        if (x < 0 || x + width > this.cols) return false

        for (let i = 0; i < height; i++) {
          for (let j = 0; j < width; j++) {
            const _r = y + i
            const _c = x + j
            if (_r >= 0 && data[i][j] && this.panel[_r][_c]) {
              return false
            }
          }
        }
        return true
      },

      updatePanel () {
        const { x: c, y: r, width, height, data } = this.currElem
        
        for (let i = 0; i < height; i++) {
          for (let j = 0; j < width; j++) {
            if (data[i][j]) this.panel[r + i][c + j] = 1
          }
        }
      },

      checkScore () {
        const { y, height } = this.currElem
        let rows = []
        for (let i = 0; i < height; i++) {
          let rowIndex = y + i
          if (rowIndex >= 0 && this.panel[rowIndex].every(item => item === 1)) {
            rows.push(rowIndex)
          }
        }

        if (rows.length) {
          this.clearRow(rows)
          this.scores += rows.length;
        }
      },

      clearRow (rows) {
        for (let i = 0; i < rows.length; i++) {
          this.panel.splice(rows[i], 1)
          this.panel.unshift(new Array(this.cols).fill(0))
        }
      }
    }

    Teris.init(document.getElementById('teris'))
  </script>

  <script>
    function start() {
      if (Teris.status !== 1) {
        Teris.start()
      }
    }
    function move(dx, dy) {
      if (Teris.status === 1 && Teris.canMove(dx, dy))
        Teris.move(dx, dy)
    }
    function moveDown() {
      if (Teris.status !== 1) return
      while(Teris.canMove(0, 1)) {
        Teris.move(0, 1)
      }
    }
    function trans() {
      if (Teris.status !== 1) return
      Teris.transform()
    }
  </script>
</body>
</html>